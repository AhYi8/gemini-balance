# 数据结构与数据库设计

## 1. 数据结构

### 1.1 应用程序配置 (app/config/config.py)

`Settings` 类定义了应用程序的所有配置项，包括：

*   **数据库配置：**
    *   `DATABASE_TYPE` (str)：数据库类型，例如 "mysql" 或 "sqlite"。
    *   `SQLITE_DATABASE` (str)：SQLite 数据库文件名。
    *   `MYSQL_HOST` (str)：MySQL 主机名。
    *   `MYSQL_PORT` (int)：MySQL 端口号。
    *   `MYSQL_USER` (str)：MySQL 用户名。
    *   `MYSQL_PASSWORD` (str)：MySQL 密码。
    *   `MYSQL_DATABASE` (str)：MySQL 数据库名。
    *   `MYSQL_SOCKET` (str)：MySQL Socket 文件路径。
*   **API 相关配置：**
    *   `API_KEYS` (List[str])：API 密钥列表。
    *   `ALLOWED_TOKENS` (List[str])：允许的令牌列表。
    *   `BASE_URL` (str)：API 基础 URL。
    *   `AUTH_TOKEN` (str)：认证令牌。
    *   `MAX_FAILURES` (int)：最大失败次数。
    *   `TEST_MODEL` (str)：测试模型。
    *   `TIME_OUT` (int)：请求超时时间（秒）。
    *   `MAX_RETRIES` (int)：最大重试次数。
    *   `PROXIES` (List[str])：代理服务器列表。
    *   `PROXIES_USE_CONSISTENCY_HASH_BY_API_KEY` (bool)：是否使用一致性哈希来选择代理。
    *   `VERTEX_API_KEYS` (List[str])：Vertex Express API 密钥列表。
    *   `VERTEX_EXPRESS_BASE_URL` (str)：Vertex Express API 基础 URL。
    *   `CUSTOM_HEADERS` (Dict[str, str])：自定义 Headers。
*   **模型相关配置：**
    *   `SEARCH_MODELS` (List[str])：搜索模型列表。
    *   `IMAGE_MODELS` (List[str])：图像模型列表。
    *   `FILTERED_MODELS` (List[str])：过滤模型列表。
    *   `TOOLS_CODE_EXECUTION_ENABLED` (bool)：是否启用代码执行工具。
    *   `URL_CONTEXT_ENABLED` (bool)：是否启用网址上下文。
    *   `URL_CONTEXT_MODELS` (List[str])：网址上下文模型列表。
    *   `SHOW_SEARCH_LINK` (bool)：是否显示搜索链接。
    *   `SHOW_THINKING_PROCESS` (bool)：是否显示思考过程。
	*	`THINKING_MODELS` (List[str]): 用于"思考过程"的模型列表
	*	`THINKING_BUDGET_MAP` (Dict[str, float]): 思考模型预算映射
*   **TTS 相关配置：**
    *   `TTS_MODEL` (str)：TTS 模型。
    *   `TTS_VOICE_NAME` (str)：TTS 语音名称。
    *   `TTS_SPEED` (str)：TTS 语速。
*   **图像生成相关配置：**
    *   `PAID_KEY` (str)：付费 API 密钥。
    *   `CREATE_IMAGE_MODEL` (str)：图像生成模型。
    *   `UPLOAD_PROVIDER` (str)：上传提供商。
    *   `SMMS_SECRET_TOKEN` (str)：SM.MS 密钥。
    *   `PICGO_API_KEY` (str)：PicGo API 密钥。
    *   `PICGO_API_URL` (str)：PicGo API 地址。
    *   `CLOUDFLARE_IMGBED_URL` (str)：Cloudflare 图床 URL。
    *   `CLOUDFLARE_IMGBED_AUTH_CODE` (str)：Cloudflare 认证码。
    *   `CLOUDFLARE_IMGBED_UPLOAD_FOLDER` (str)：Cloudflare 上传文件夹。
*   **流式输出优化器配置：**
    *   `STREAM_OPTIMIZER_ENABLED` (bool)：是否启用流式输出优化。
    *   `STREAM_MIN_DELAY` (float)：最小延迟（秒）。
    *   `STREAM_MAX_DELAY` (float)：最大延迟（秒）。
    *   `STREAM_SHORT_TEXT_THRESHOLD` (int)：短文本阈值。
    *   `STREAM_LONG_TEXT_THRESHOLD` (int)：长文本阈值。
    *   `STREAM_CHUNK_SIZE` (int)：分块大小。
*   **假流式配置：**
    *   `FAKE_STREAM_ENABLED` (bool)：是否启用假流式输出。
    *   `FAKE_STREAM_EMPTY_DATA_INTERVAL_SECONDS` (int)：假流式空数据发送间隔（秒）。
*   **调度器配置：**
    *   `CHECK_INTERVAL_HOURS` (int)：检查间隔（小时）。
    *   `TIMEZONE` (str)：时区。
*   **Github 配置:**
    *   `GITHUB_REPO_OWNER` (str): Github 仓库所有者
    *   `GITHUB_REPO_NAME` (str): Github 仓库名称
*   **日志配置：**
    *   `LOG_LEVEL` (str)：日志级别。
    *   `AUTO_DELETE_ERROR_LOGS_ENABLED` (bool)：是否开启自动删除错误日志。
    *   `AUTO_DELETE_ERROR_LOGS_DAYS` (int)：自动删除多少天前的错误日志。
    *   `AUTO_DELETE_REQUEST_LOGS_ENABLED` (bool)：是否开启自动删除请求日志。
    *   `AUTO_DELETE_REQUEST_LOGS_DAYS` (int)：自动删除多少天前的请求日志。
    *   `SAFETY_SETTINGS` (List[Dict[str, str]])：安全设置。
*   **Files API:**
    *   `FILES_CLEANUP_ENABLED` (bool): 是否启用文件清理
    *   `FILES_CLEANUP_INTERVAL_HOURS` (int): 文件清理间隔小时
    *   `FILES_USER_ISOLATION_ENABLED` (bool): 是否启用文件用户隔离
*   **Admin Session Configuration:**
    *   `ADMIN_SESSION_EXPIRE` (int): Admin session expiration time in seconds (5 minutes to 24 hours)

### 1.2 文件 API 相关模型 (app/domain/file\_models.py)

*   `FileUploadConfig`：文件上传配置
*   `CreateFileRequest`：创建文件请求
*   `FileMetadata`：文件元数据
*   `ListFilesRequest`：列出文件请求
*   `ListFilesResponse`：列出文件响应
*   `UploadInitResponse`：上传初始化响应
*   `FileKeyMapping`：文件与 API Key 映射
*   `DeleteFileResponse`：删除文件响应

### 1.3 Gemini API 相关模型 (app/domain/gemini\_models.py)

*   `SafetySetting`：安全设置
*   `GenerationConfig`：生成配置
*   `SystemInstruction`：系统指令
*   `GeminiContent`：Gemini 内容
*   `GeminiRequest`：Gemini 请求
*   `ResetSelectedKeysRequest`：重置选定密钥请求
*   `VerifySelectedKeysRequest`：验证选定密钥请求
*   `GeminiEmbedContent`：嵌入内容
*   `GeminiEmbedRequest`：嵌入请求
*   `GeminiBatchEmbedRequest`：批量嵌入请求

### 1.4 图像生成 API 相关模型 (app/domain/image\_models.py)

*   `ImageMetadata`：图像元数据
*   `UploadResponse`：上传响应
*   `ImageUploader`：图像上传器

### 1.5 OpenAI API 相关模型 (app/domain/openai\_models.py)

*   `ChatRequest`：聊天请求
*   `EmbeddingRequest`：嵌入请求
*   `ImageGenerationRequest`：图像生成请求
*   `TTSRequest`：TTS 请求

## 2. 数据库表设计 (app/database/models.py)

### 2.1 Settings (t\_settings)

| 字段名      | 类型          | 描述         |
| ----------- | ------------- | ------------ |
| id          | Integer       | 主键，自增长 |
| key         | String(100)   | 配置项键名     |
| value       | Text          | 配置项值       |
| description | String(255)   | 配置项描述     |
| created\_at  | DateTime      | 创建时间       |
| updated\_at  | DateTime      | 更新时间       |

### 2.2 ErrorLog (t\_error\_logs)

| 字段名      | 类型          | 描述             |
| ----------- | ------------- | ---------------- |
| id          | Integer       | 主键，自增长     |
| gemini\_key | String(100)   | Gemini API 密钥 |
| model\_name | String(100)   | 模型名称         |
| error\_type | String(50)    | 错误类型         |
| error\_log  | Text          | 错误日志         |
| error\_code | Integer       | 错误代码         |
| request\_msg | JSON          | 请求消息         |
| request\_time | DateTime      | 请求时间         |

### 2.3 RequestLog (t\_request\_log)

| 字段名       | 类型          | 描述         |
| ------------ | ------------- | ------------ |
| id           | Integer       | 主键，自增长 |
| request\_time | DateTime      | 请求时间       |
| model\_name  | String(100)   | 模型名称     |
| api\_key     | String(100)   | 使用的 API 密钥 |
| is\_success  | Boolean       | 请求是否成功   |
| status\_code | Integer       | API 响应状态码 |
| latency\_ms  | Integer       | 请求耗时(毫秒) |

### 2.4 FileRecord (t\_file\_records)

| 字段名          | 类型          | 描述                               |
| --------------- | ------------- | ---------------------------------- |
| id              | Integer       | 主键，自增长                       |
| name            | String(255)   | 文件名称，格式: files/{file\_id}   |
| display\_name   | String(255)   | 用户上传时的原始文件名             |
| mime\_type      | String(100)   | MIME 类型                          |
| size\_bytes     | BigInteger    | 文件大小（字节）                     |
| sha256\_hash   | String(255)   | 文件的 SHA256 哈希值               |
| state           | Enum(FileState) | 文件状态                           |
| create\_time    | DateTime      | 创建时间                           |
| update\_time    | DateTime      | 更新时间                           |
| expiration\_time | DateTime      | 过期时间                           |
| uri             | String(500)   | 文件访问 URI                       |
| api\_key        | String(100)   | 上传时使用的 API Key               |
| upload\_url     | Text          | 临时上传 URL（用于分块上传）        |
| user\_token     | String(100)   | 上传用户的 token                   |
| upload\_completed | DateTime      | 上传完成时间                       |

## 3. 表关系

目前，各个表之间没有直接的外键关联关系。

## 4. API_KEY 相关

### 4.1 前端批量添加 API_KEY 如何保存到数据库中

1.  用户在前端配置页面的 "API 密钥列表" 中，通过模态框批量添加 API 密钥。
2.  前端使用 `handleBulkAddApiKeys` 函数处理批量添加的 API 密钥，该函数从 `apiKeyBulkInput` 文本框中获取用户输入的 API 密钥，并使用正则表达式 `API_KEY_REGEX` 提取有效的 API 密钥。
3.  `handleBulkAddApiKeys` 函数将提取的 API 密钥与现有的 API 密钥合并，并进行去重操作，最终更新前端的 `allApiKeys` 数组。
4.  用户点击 "保存配置" 按钮，触发 `saveConfig` 函数。
5.  `saveConfig` 函数调用 `collectFormData` 函数，收集所有配置项的数据，包括 `API_KEYS` 列表。
6.  `collectFormData` 函数从前端的 `allApiKeys` 数组中获取 API 密钥列表，并将其添加到 `formData` 对象中。
7.  `saveConfig` 函数将 `formData` 对象发送到后端的 `/api/config` 接口。

### 4.2 前端请求接口时如何随机读取 API_KEY 的

前端代码**没有随机读取 API\_KEY 的逻辑**。前端只是将配置数据发送到后端，由后端负责选择 API\_KEY。

### 4.3 数据库中 API_KEY(s) 是如何存储的

*   API 密钥存储在 `t_settings` 表中。
*   `key` 字段为 `"API_KEYS"`。
*   `value` 字段存储的是一个 JSON 字符串，表示 API 密钥的列表。例如：`["AIzaSy...", "AIzaSy...", ...]`。

### 4.4 后端如何处理 API_KEY

*   **`app/service/config/config_service.py`：**
    *   `ConfigService.update_config` 方法负责将配置数据保存到数据库中。
    *   该方法接收包含配置数据的字典 `config_data`，并将其中的 `API_KEYS` 列表转换为 JSON 字符串，然后存储到 `t_settings` 表的 `value` 字段中。
    *   `ConfigService.delete_key` 和 `ConfigService.delete_selected_keys` 方法负责删除 API 密钥，并更新数据库。
*   **`app/service/key/key_manager.py`：**
    *   `KeyManager` 类负责管理 API 密钥。
    *   `get_next_key` 方法使用 `itertools.cycle` 循环获取 API 密钥，保证每个密钥都有机会被使用。
    *   `get_random_valid_key` 方法用于获取随机的有效 API 密钥。该方法首先获取所有有效的 API 密钥，然后使用 `random.choice` 随机选择一个。
